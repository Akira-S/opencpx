#!/usr/local/bin/perl
## $SMEId: vps2/user/local/cpx/vinstall/cpx.uninstall,v 1.6 2006/09/09 19:24:24 nbroderick Exp $
## Added check for file ~/.ncsbr. If present skip clamav and spamassassin display.
##
use strict;
use File::Copy qw( mv );

BEGIN {
    unshift @INC, '/usr/local/cp/lib/';
}

if( $^O eq 'linux' )
{
    require VPS::Config;
    import VPS::Config qw( remove_block print_block );
}
else
{
    require VPS::Install;
    import VPS::Install qw( remove_block print_block );
}

my $home = $ENV{"HOME"};
if (! $home) { print STDERR "Warn: \$home is not set.\n" }

if( $^O eq 'linux' ) {
    system("/sbin/chkconfig clamd off > /dev/null 2>&1");
    system("/sbin/service clamd stop > /dev/null 2>&1");
    system("/sbin/chkconfig vsapd off > /dev/null 2>&1");
    system("/sbin/service vsapd stop > /dev/null 2>&1");
    system("/sbin/chkconfig spamassassin off > /dev/null 2>&1");
    system("/sbin/service spamassassin stop > /dev/null 2>&1");
}
else
{
    ## start vsapd -- make sure not running
    system( '/usr/local/cp/sbin/vsapd.sh stop >/dev/null 2>&1' );

    if( !system( '/usr/bin/egrep', '-iqs', '^vsapd_enable="YES"', '/etc/rc.conf' )) {
        mv( '/etc/rc.conf', '/etc/rc.conf.bak' );
        system( "/usr/bin/grep -v vsapd_enable /etc/rc.conf.bak > /etc/rc.conf" );
    }
}

remove_block( '/www/conf/httpd.conf', '^## <===CPX.+start===>$', '^## <===CPX.+end===>$' );
system( '/usr/local/sbin/restart_apache >/dev/null 2>&1' );

if ($home and ! -e "$home/.ncsbr") {
print_block( [ '',
               'This script turned off vsapd and removed the CPX block from the httpd.conf',
               '', 
               'It did not uninstall Savelogs, ClamAV, SpamAssassin or change any ',
               'other configurations. (e.g. procmail-lda mail setup, virtusertable',
               'or genericstable entries) ',
               '',
             ], 80, '-' );
} else {
print_block( [ '',
               'This script turned off vsapd and removed the CPX block from the httpd.conf',
               '', 
               'It did not uninstall Savelogs or change any other',
               'configurations. (e.g. procmail-lda mail setup,',
               'virtusertable or genericstable entries) ',
               '',
             ], 80, '-' );
}

exit;
